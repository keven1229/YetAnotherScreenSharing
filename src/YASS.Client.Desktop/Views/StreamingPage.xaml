<ui:FluentWindow x:Class="YASS.Client.Desktop.Views.StreamingPage"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        mc:Ignorable="d"
        Title="推流地址" Height="700" Width="700"
        WindowStartupLocation="CenterOwner"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 标题栏 -->
        <ui:TitleBar Grid.Row="0" Title="推流地址" />

        <!-- 主内容（带滚动条） -->
        <ScrollViewer Grid.Row="1" 
                      VerticalScrollBarVisibility="Auto" 
                      HorizontalScrollBarVisibility="Disabled">
            <Grid Margin="24">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 房间信息 -->
            <ui:Card Grid.Row="0" Margin="0,0,0,16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <ui:TextBlock Text="{Binding RoomName}" FontTypography="BodyStrong"/>
                        <ui:TextBlock Text="{Binding StatusMessage}" Opacity="0.7" FontSize="12"/>
                    </StackPanel>
                </Grid>
            </ui:Card>

            <!-- RTMP推流地址 -->
            <ui:Card Grid.Row="1" Margin="0,0,0,16">
                <StackPanel>
                    <ui:TextBlock Text="推流地址" FontTypography="BodyStrong" Margin="0,0,0,12"/>
                    
                    <!-- RTMP服务器地址 -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBlock Text="服务器:" VerticalAlignment="Center" Opacity="0.7"/>
                        <ui:TextBox Grid.Column="1" 
                                   Text="{Binding RtmpUrl, Mode=OneWay}" 
                                   IsReadOnly="True" 
                                   Margin="0,0,8,0"/>
                        <ui:Button Grid.Column="2" 
                                  Content="复制" 
                                  Command="{Binding CopyRtmpUrlCommand}"
                                  Icon="{ui:SymbolIcon Copy24}"/>
                    </Grid>

                    <!-- 流密钥 -->
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBlock Text="流密钥:" VerticalAlignment="Center" Opacity="0.7"/>
                        <ui:TextBox Grid.Column="1" 
                                   Text="{Binding StreamKey, Mode=OneWay}" 
                                   IsReadOnly="True" 
                                   Margin="0,0,8,0"/>
                        <ui:Button Grid.Column="2" 
                                  Content="复制" 
                                  Command="{Binding CopyStreamKeyCommand}"
                                  Icon="{ui:SymbolIcon Copy24}"/>
                    </Grid>

                    <!-- 完整地址 -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <ui:TextBlock Text="完整地址:" VerticalAlignment="Center" Opacity="0.7"/>
                        <ui:TextBox Grid.Column="1" 
                                   IsReadOnly="True" 
                                   Margin="0,0,8,0">
                            <ui:TextBox.Text>
                                <MultiBinding StringFormat="{}{0}/{1}">
                                    <Binding Path="RtmpUrl"/>
                                    <Binding Path="StreamKey"/>
                                </MultiBinding>
                            </ui:TextBox.Text>
                        </ui:TextBox>
                        <ui:Button Grid.Column="2" 
                                  Content="复制" 
                                  Command="{Binding CopyFullUrlCommand}"
                                  Icon="{ui:SymbolIcon Copy24}"/>
                    </Grid>

                    <!-- 使用说明 -->
                    <ui:InfoBar Margin="0,12,0,0" 
                               Title="使用说明" 
                               Severity="Informational"
                               IsOpen="True"
                               IsClosable="False">
                        <ui:InfoBar.Content>
                            <StackPanel>
                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                                    使用 OBS Studio、FFmpeg 或其他推流工具将您的屏幕内容推送到上述RTMP地址。
                                </TextBlock>
                                <TextBlock TextWrapping="Wrap" FontWeight="SemiBold" Margin="0,4,0,4">
                                    OBS Studio 设置：
                                </TextBlock>
                                <TextBlock TextWrapping="Wrap" Margin="0,0,0,4">
                                    1. 设置 → 推流 → 服务：自定义<LineBreak/>
                                    2. 填入上方的"服务器"和"流密钥"<LineBreak/>
                                    3. 添加"显示器采集"或"窗口采集"源<LineBreak/>
                                    4. 点击"开始推流"
                                </TextBlock>
                                <TextBlock TextWrapping="Wrap" FontWeight="SemiBold" Margin="0,8,0,4">
                                    FFmpeg 命令示例：
                                </TextBlock>
                                <ui:TextBox IsReadOnly="True" 
                                           FontFamily="Consolas" 
                                           FontSize="11"
                                           TextWrapping="Wrap">
                                    <ui:TextBox.Text>
                                        <MultiBinding StringFormat="ffmpeg -f gdigrab -i desktop -c:v libx264 -preset ultrafast -tune zerolatency -f flv {0}/{1}">
                                            <Binding Path="RtmpUrl"/>
                                            <Binding Path="StreamKey"/>
                                        </MultiBinding>
                                    </ui:TextBox.Text>
                                </ui:TextBox>
                            </StackPanel>
                        </ui:InfoBar.Content>
                    </ui:InfoBar>

                    <!-- 一键FFmpeg推流 -->
                    <ui:Card Margin="0,16,0,0">
                        <StackPanel>
                            <ui:TextBlock Text="一键推流（内置FFmpeg）" FontTypography="BodyStrong" Margin="0,0,0,12"/>
                            
                            <!-- 捕获方式选择 -->
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <ui:TextBlock Text="捕获方式:" VerticalAlignment="Center" Opacity="0.7"/>
                                <ComboBox Grid.Column="1" 
                                          ItemsSource="{Binding CaptureMethodOptions}"
                                          SelectedItem="{Binding SelectedCaptureMethod}"
                                          IsEnabled="{Binding IsFFmpegStreaming, Converter={StaticResource InverseBoolConverter}}"
                                          Width="150"
                                          HorizontalAlignment="Left"/>
                            </Grid>

                            <!-- 音频源选择 -->
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <ui:TextBlock Text="音频源:" VerticalAlignment="Center" Opacity="0.7"/>
                                <ComboBox Grid.Column="1" 
                                          ItemsSource="{Binding AudioSourceOptions}"
                                          SelectedItem="{Binding SelectedAudioSource}"
                                          IsEnabled="{Binding IsFFmpegStreaming, Converter={StaticResource InverseBoolConverter}}"
                                          Width="300"
                                          HorizontalAlignment="Left"/>
                            </Grid>

                            <!-- 输出分辨率选择 -->
                            <Grid Margin="0,0,0,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <ui:TextBlock Text="输出分辨率:" VerticalAlignment="Center" Opacity="0.7"/>
                                <ComboBox Grid.Column="1" 
                                          ItemsSource="{Binding OutputResolutionOptions}"
                                          SelectedItem="{Binding SelectedOutputResolution}"
                                          IsEnabled="{Binding IsFFmpegStreaming, Converter={StaticResource InverseBoolConverter}}"
                                          Width="180"
                                          HorizontalAlignment="Left"/>
                                <!-- 自定义分辨率输入 -->
                                <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="12,0,0,0"
                                           Visibility="{Binding IsCustomResolution, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <ui:TextBox Text="{Binding CustomWidth, UpdateSourceTrigger=PropertyChanged}" 
                                               Width="70"
                                               IsEnabled="{Binding IsFFmpegStreaming, Converter={StaticResource InverseBoolConverter}}"/>
                                    <ui:TextBlock Text="x" VerticalAlignment="Center" Margin="8,0"/>
                                    <ui:TextBox Text="{Binding CustomHeight, UpdateSourceTrigger=PropertyChanged}" 
                                               Width="70"
                                               IsEnabled="{Binding IsFFmpegStreaming, Converter={StaticResource InverseBoolConverter}}"/>
                                </StackPanel>
                            </Grid>

                            <!-- 推流控制按钮 -->
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                                <ui:Button Content="帮我推流（FFmpeg）" 
                                          Command="{Binding StartFFmpegStreamingCommand}"
                                          Appearance="Primary"
                                          Icon="{ui:SymbolIcon Play24}"
                                          IsEnabled="{Binding IsFFmpegStreaming, Converter={StaticResource InverseBoolConverter}}"
                                          Margin="0,0,8,0"/>
                                <ui:Button Content="停止推流" 
                                          Command="{Binding StopFFmpegStreamingCommand}"
                                          Appearance="Danger"
                                          Icon="{ui:SymbolIcon Stop24}"
                                          IsEnabled="{Binding IsFFmpegStreaming}"/>
                            </StackPanel>

                            <!-- 提示信息 -->
                            <ui:InfoBar Margin="0,12,0,0" 
                                       Title="提示" 
                                       Severity="Informational"
                                       IsOpen="True"
                                       IsClosable="False">
                                <ui:InfoBar.Content>
                                    <TextBlock TextWrapping="Wrap">
                                        请将 ffmpeg.exe 放入应用程序的 ffmpeg 或 tools 文件夹中。<LineBreak/>
                                        <LineBreak/>
                                        【捕获方式】<LineBreak/>
                                        • gdigrab: Windows GDI屏幕捕获（推荐）<LineBreak/>
                                        <LineBreak/>
                                        【音频源】<LineBreak/>
                                        • 静音: 不捕获音频，但会生成静音音轨<LineBreak/>
                                        • 立体声混音: 捕获系统音频（需要在声音设置中启用）<LineBreak/>
                                        • 麦克风: 捕获麦克风输入
                                    </TextBlock>
                                </ui:InfoBar.Content>
                            </ui:InfoBar>
                        </StackPanel>
                    </ui:Card>
                </StackPanel>
            </ui:Card>

            <!-- 推流配置信息 -->
            <ui:Card Grid.Row="2">
                <StackPanel>
                    <ui:TextBlock Text="推荐配置" FontTypography="BodyStrong" Margin="0,0,0,8"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,8">
                            <ui:TextBlock Text="分辨率" FontSize="11" Opacity="0.6"/>
                            <ui:TextBlock Text="1920x1080 推荐" FontSize="13"/>
                        </StackPanel>

                        <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,0,8">
                            <ui:TextBlock Text="帧率" FontSize="11" Opacity="0.6"/>
                            <ui:TextBlock Text="30 FPS" FontSize="13"/>
                        </StackPanel>

                        <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,8,8,8">
                            <ui:TextBlock Text="编码器" FontSize="11" Opacity="0.6"/>
                            <ui:TextBlock Text="H.264 / x264" FontSize="13"/>
                        </StackPanel>

                        <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,8,0,8">
                            <ui:TextBlock Text="预设" FontSize="11" Opacity="0.6"/>
                            <ui:TextBlock Text="ultrafast / veryfast" FontSize="13"/>
                        </StackPanel>

                        <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,8,8,0">
                            <ui:TextBlock Text="码率控制" FontSize="11" Opacity="0.6"/>
                            <ui:TextBlock Text="CBR (固定码率)" FontSize="13"/>
                        </StackPanel>

                        <StackPanel Grid.Row="2" Grid.Column="1" Margin="8,8,0,0">
                            <ui:TextBlock Text="关键帧间隔" FontSize="11" Opacity="0.6"/>
                            <ui:TextBlock Text="2秒" FontSize="13"/>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </ui:Card>
        </Grid>
        </ScrollViewer>
    </Grid>
</ui:FluentWindow>
