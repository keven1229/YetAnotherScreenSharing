<ui:FluentWindow x:Class="YASS.Client.Desktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:local="clr-namespace:YASS.Client.Desktop"
        xmlns:vm="clr-namespace:YASS.Client.Desktop.ViewModels"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="YASS - Yet Another Screen Sharing" 
        Height="700" Width="1100"
        MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 标题栏 -->
        <ui:TitleBar Grid.Row="0" Title="YASS - Yet Another Screen Sharing">
            <ui:TitleBar.Icon>
                <ui:SymbolIcon Symbol="ShareScreenStart24" />
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <!-- 主内容区 -->
        <Grid Grid.Row="1" Margin="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧面板 - 房间和捕获源 -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 房间列表 -->
                <ui:TextBlock Grid.Row="0" Text="房间列表" FontTypography="BodyStrong" Margin="0,0,0,8"/>
                <ui:ListView Grid.Row="1" 
                            ItemsSource="{Binding Rooms}" 
                            SelectedItem="{Binding SelectedRoom}"
                            Margin="0,0,16,16">
                    <ui:ListView.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="8,4">
                                <ui:SymbolIcon Symbol="Video24" Margin="0,0,8,0"/>
                                <StackPanel>
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding Status}" FontSize="11" Opacity="0.7"/>
                                </StackPanel>
                            </StackPanel>
                        </DataTemplate>
                    </ui:ListView.ItemTemplate>
                </ui:ListView>

                <!-- 创建房间 -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,16,16">
                    <ui:TextBox PlaceholderText="房间名称" 
                               Text="{Binding NewRoomName, UpdateSourceTrigger=PropertyChanged}" 
                               Width="180" Margin="0,0,8,0"/>
                    <ui:Button Content="创建" Command="{Binding CreateRoomCommand}" Icon="{ui:SymbolIcon Add24}"/>
                </StackPanel>

                <!-- 捕获源 -->
                <ui:TextBlock Grid.Row="3" Text="捕获源" FontTypography="BodyStrong" Margin="0,0,0,8" VerticalAlignment="Top"/>
                <ui:ListView Grid.Row="3" 
                            ItemsSource="{Binding CaptureSources}" 
                            SelectedItem="{Binding SelectedCaptureSource}"
                            Margin="0,28,16,0">
                    <ui:ListView.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Margin="8,4">
                                <ui:SymbolIcon Symbol="Desktop24" Margin="0,0,8,0"/>
                                <StackPanel>
                                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" MaxWidth="200"/>
                                    <TextBlock FontSize="11" Opacity="0.7">
                                        <Run Text="{Binding Width}"/>
                                        <Run Text="x"/>
                                        <Run Text="{Binding Height}"/>
                                    </TextBlock>
                                </StackPanel>
                            </StackPanel>
                        </DataTemplate>
                    </ui:ListView.ItemTemplate>
                </ui:ListView>
            </Grid>

            <!-- 右侧面板 - 设置和推流控制 -->
            <Grid Grid.Column="1" Margin="16,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 推流设置 -->
                <ui:CardExpander Grid.Row="0" Header="推流设置" IsExpanded="True" Margin="0,0,0,16">
                    <Grid Margin="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- 分辨率 -->
                        <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,12">
                            <ui:TextBlock Text="分辨率" Margin="0,0,0,4"/>
                            <StackPanel Orientation="Horizontal">
                                <ui:NumberBox Value="{Binding StreamConfig.Width}" Minimum="640" Maximum="7680" Width="90"/>
                                <ui:TextBlock Text="x" Margin="8,0" VerticalAlignment="Center"/>
                                <ui:NumberBox Value="{Binding StreamConfig.Height}" Minimum="480" Maximum="4320" Width="90"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- 帧率 -->
                        <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,0,12">
                            <ui:TextBlock Text="帧率 (FPS)" Margin="0,0,0,4"/>
                            <ui:NumberBox Value="{Binding StreamConfig.FrameRate}" Minimum="1" Maximum="240" Width="120"/>
                        </StackPanel>

                        <!-- 码率 -->
                        <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,8,12">
                            <ui:TextBlock Text="码率 (Kbps)" Margin="0,0,0,4"/>
                            <ui:NumberBox Value="{Binding StreamConfig.VideoBitrate}" Minimum="500" Maximum="50000" Width="120"/>
                        </StackPanel>

                        <!-- 编码格式 -->
                        <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,0,0,12">
                            <ui:TextBlock Text="编码格式" Margin="0,0,0,4"/>
                            <ComboBox SelectedValue="{Binding StreamConfig.Codec}" 
                                     ItemsSource="{Binding Source={x:Static local:EnumHelper.CodecTypes}}"
                                     Width="120"/>
                        </StackPanel>

                        <!-- 编码器 -->
                        <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,8,12">
                            <ui:TextBlock Text="编码器" Margin="0,0,0,4"/>
                            <ComboBox SelectedValue="{Binding StreamConfig.Encoder}" 
                                     ItemsSource="{Binding Source={x:Static local:EnumHelper.EncoderTypes}}"
                                     Width="120"/>
                        </StackPanel>

                        <!-- 预设 -->
                        <StackPanel Grid.Row="2" Grid.Column="1" Margin="8,0,0,12">
                            <ui:TextBlock Text="编码预设" Margin="0,0,0,4"/>
                            <ComboBox SelectedItem="{Binding StreamConfig.Preset, Mode=TwoWay}" Width="120">
                                <sys:String>ultrafast</sys:String>
                                <sys:String>superfast</sys:String>
                                <sys:String>veryfast</sys:String>
                                <sys:String>faster</sys:String>
                                <sys:String>fast</sys:String>
                                <sys:String>medium</sys:String>
                                <sys:String>slow</sys:String>
                            </ComboBox>
                        </StackPanel>

                        <!-- 检测到的编码器 -->
                        <StackPanel Grid.Row="3" Grid.ColumnSpan="2">
                            <ui:TextBlock Text="可用硬件编码器:" Margin="0,0,0,4" FontSize="12" Opacity="0.7"/>
                            <ItemsControl ItemsSource="{Binding AvailableEncoders}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <ui:Badge Appearance="Secondary" Margin="0,0,8,0">
                                            <TextBlock Text="{Binding EncoderType}"/>
                                        </ui:Badge>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Grid>
                </ui:CardExpander>

                <!-- 推流状态 / 预览区域 -->
                <Border Grid.Row="1" Background="{ui:ThemeResource ControlFillColorDefaultBrush}" 
                       CornerRadius="8" Margin="0,0,0,16">
                    <Grid>
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <ui:SymbolIcon Symbol="VideoClip24" FontSize="48" Margin="0,0,0,16"/>
                            <ui:TextBlock Text="选择捕获源和房间后开始推流" 
                                         HorizontalAlignment="Center" Opacity="0.7"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- 推流控制按钮 -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                    <ui:Button Content="刷新" 
                              Command="{Binding RefreshCaptureSourcesCommand}" 
                              Margin="0,0,8,0"
                              Icon="{ui:SymbolIcon ArrowSync24}"/>
                    <ui:Button Content="保存设置" 
                              Command="{Binding SaveSettingsCommand}" 
                              Margin="0,0,8,0"
                              Icon="{ui:SymbolIcon Save24}"/>
                    <ui:Button Content="开始推流" 
                              Command="{Binding OpenStreamingViewCommand}"
                              Appearance="Primary"
                              Icon="{ui:SymbolIcon Play24}"/>
                </StackPanel>
            </Grid>
        </Grid>

        <!-- 状态栏 -->
        <Border Grid.Row="2" Background="{ui:ThemeResource ControlFillColorDefaultBrush}" Padding="16,8">
            <Grid>
                <ui:TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"/>
                <ProgressBar IsIndeterminate="True" Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" 
                            HorizontalAlignment="Right" Width="100"/>
            </Grid>
        </Border>
    </Grid>
</ui:FluentWindow>
